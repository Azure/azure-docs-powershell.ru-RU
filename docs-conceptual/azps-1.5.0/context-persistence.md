---
title: Использование учетных данных пользователя в разных сеансах PowerShell
description: Узнайте, как использовать учетные данные Azure и другие сведения в нескольких сеансах PowerShell.
author: sptramer
ms.author: sttramer
manager: carmonm
ms.devlang: powershell
ms.topic: conceptual
ms.date: 12/13/2018
ms.openlocfilehash: 8702de48429482748939fb1a43ff911bed15f6c0
ms.sourcegitcommit: 447276d46ffeeb37f0c07a570536665e36c5ddb8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2019
ms.locfileid: "57882531"
---
# <a name="persist-user-credentials-across-powershell-sessions"></a>Использование учетных данных пользователя в разных сеансах PowerShell

В Azure PowerShell существует функция **автосохранения контекста Azure**, которая предоставляет следующие возможности:

- хранение учетных данных для входа для повторного использования в новых сеансах PowerShell;
- упрощенное использование фоновых задач для запуска долго выполняющихся командлетов;
- переключение между учетными записями, подписками и средами без необходимости выполнять отдельный вход;
- одновременное выполнение задач с использованием разных учетных данных и подписок в рамках одного сеанса PowerShell.

## <a name="azure-contexts-defined"></a>Определенные контексты Azure

*Контекст Azure* — это набор сведений, которые определяют целевой объект для командлетов Azure PowerShell. Контекст состоит из пяти частей:

- *Учетная запись* — имя пользователя или субъекта-службы, которое используется для аутентификации при обмене данными со средой Azure.
- *Подписка* — подписка Azure с используемыми ресурсами.
- *Клиент* — клиент Azure Active Directory, который содержит вашу подписку. Клиенты являются более важными при аутентификации субъекта-службы.
- *Среда* — определяемое облако Azure (обычно это глобальное облако Azure).
  Кроме того, параметр среды позволяет определять национальные и локальные (Azure Stack) облака, а также облака для государственных организаций.
- *Учетные данные* — сведения, которые используются в Azure, чтобы выполнить идентификацию и авторизацию для доступа к ресурсам в Azure.

В последней версии Azure PowerShell контексты Azure автоматически сохраняются при каждом открытии нового сеанса PowerShell.

## <a name="automatically-save-the-context-for-the-next-sign-in"></a>Автоматическое сохранение контекста для следующего входа

В Azure PowerShell данные контекста автоматически сохраняются между сеансами. Чтобы PowerShell не сохранял учетные данные и данные контекста, используйте `Disable-AzContextAutoSave`. Если сохранение контекста отключено, вам нужно будет каждый раз при открытии сеанса PowerShell входить в Azure.

Чтобы разрешить Azure PowerShell запоминать контекст после закрытия сеанса PowerShell, используйте `Enable-AzContextAutosave`. Учетные данные и данные контекста автоматически сохраняются в специальной скрытой папке в каталоге пользователя (`$env:USERPROFILE\.Azure` — на Windows и `$HOME/.Azure` — на других платформах). Каждый новый сеанс PowerShell обращается к контексту, который использовался в последнем сеансе.

Командлеты, которые помогают управлять контекстами Azure, также предоставляют удобные средства. С их помощью вы можете применить изменения как для текущего сеанса PowerShell (область `Process`), так и для всех сеансов PowerShell (область `CurrentUser`). Эти параметры подробно описаны в разделе [Использование областей контекстов](#Using-Context-Scopes).

## <a name="running-azure-powershell-cmdlets-as-background-jobs"></a>Выполнение командлетов Azure PowerShell как фоновых заданий

Функция **автосохранения контекста Azure** также позволяет использовать контекст с фоновыми заданиями PowerShell. PowerShell позволяет запускать и отслеживать долго выполняющиеся задачи как фоновые задания. Для этого вам не нужно дожидаться завершения их выполнения. Чтобы использовать в фоновых заданиях учетные данные, можно сделать следующее:

- Передать контекст как аргумент.

  Большинство командлетов AzureRM позволяют передавать контекст как параметр. Передать контекст в фоновое задание можно так:

  ```powershell-interactive
  PS C:\> $job = Start-Job { param ($ctx) New-AzVm -AzureRmContext $ctx [... Additional parameters ...]} -ArgumentList (Get-AzContext)
  ```

- Использовать контекст по умолчанию со включенной функцией автосохранения

  Если включить функцию **автосохранения контекста**, фоновые задания будут автоматически использовать сохраненный контекст по умолчанию.

  ```powershell-interactive
  PS C:\> $job = Start-Job { New-AzVm [... Additional parameters ...]}
  ```

Если вам нужно узнать выходные данные фоновой задачи, используйте `Get-Job`, чтобы проверить состояние задания, и `Wait-Job`, чтобы дождаться завершения задания. Используйте `Receive-Job`, чтобы записать или отобразить выходные данные фонового задания. См. дополнительные сведения о [заданиях](/powershell/module/microsoft.powershell.core/about/about_jobs).

## <a name="creating-selecting-renaming-and-removing-contexts"></a>Создание, выбор, переименование и удаление контекстов

Чтобы создать контекст, нужно войти в Azure. Командлет `Connect-AzAccount` (или его псевдоним `Login-AzAccount`) определяет контекст по умолчанию, который будет использоваться командлетами Azure PowerShell. Он также обеспечивает доступ к любому клиенту или подписке в рамках разрешений, предоставляемых вашими учетными данными.

Чтобы добавить новый контекст после входа, используйте командлет `Set-AzContext` (или его псевдоним `Select-AzSubscription`).

```azurepowershell-interactive
PS C:\> Set-AzContext -Subscription "Contoso Subscription 1" -Name "Contoso1"
```

В примере выше мы добавили новый контекст для подписки "Contoso Subscription 1", используя текущие учетные данные. Новый контекст называется "Contoso1". Если вы не укажете имя для контекста, будет использоваться имя по умолчанию на основе идентификатора учетной записи и подписки.

Чтобы переименовать существующий контекста, используйте командлет `Rename-AzContext`. Например: 

```azurepowershell-interactive
PS C:\> Rename-AzContext '[user1@contoso.org; 123456-7890-1234-564321]` 'Contoso2'
```

В этом примере мы изменяем стандартное имя контекста `[user1@contoso.org; 123456-7890-1234-564321]` на простое имя "Contoso2". Командлеты, которые управляют контекстами, также поддерживают заполнение нажатием клавиши TAB. Это позволяет быстро выбрать контекст.

Наконец, чтобы удалить контекст, используйте командлет `Remove-AzContext`.  Например: 

```azurepowershell-interactive
PS C:\> Remove-AzContext Contoso2
```

Удаление контекста с именем "Contoso2". Этот контекст можно создать повторно с помощью командлета `Set-AzContext`.

## <a name="removing-credentials"></a>Удаление учетных данных

Вы можете удалить все учетные данные и связанные контексты пользователя или субъекта-службы с помощью командлета `Disconnect-AzAccount` (или его псевдонима `Logout-AzAccount`). Выполняемый без параметров командлет `Disconnect-AzAccount` удаляет все учетные данные и контексты, связанные с пользователем или субъектом-службой в текущем контексте. Чтобы связать с контекстом определенный субъект, вы можете передать имя пользователя, имя субъекта-службы или сам контекст.

```azurepowershell-interactive
Disconnect-AzAccount user1@contoso.org
```

## <a name="using-context-scopes"></a>Использование областей контекстов

Иногда нужно выбрать, изменить или удалить контекст в сеансе PowerShell, не влияя на другие сеансы. Чтобы изменить стандартное поведение командлетов, управляющих контекстом, используйте параметр `Scope`. Область `Process` переопределяет стандартное поведение, ограничивая его действие текущим сеансом. И наоборот, область `CurrentUser` изменяет контекст во всех сеансах, а не только в текущем.

Например, вот как можно изменить контекст по умолчанию в текущем сеансе PowerShell, не влияя на другие окна, или изменить контекст, который будет использоваться при следующем открытии сеанса:

```azurepowershell-interactive
PS C:\> Select-AzContext Contoso1 -Scope Process
```

## <a name="how-the-context-autosave-setting-is-remembered"></a>Запоминание параметра автосохранения контекста

Параметр автосохранения контекста сохраняется в каталоге пользователя Azure PowerShell (`$env:USERPROFILE\.Azure` — на Windows и `$HOME/.Azure` — на других платформах). На некоторых компьютерах учетные записи могут не иметь доступ к этому каталогу. В таких случаях можно использовать переменную среды

```azurepowershell-interactive
$env:AzureRmContextAutoSave="true" | "false"
```

Если задано значение true, контекст сохраняется автоматически. Если задано значение false, контекст не сохраняется.

## <a name="context-management-cmdlets"></a>Командлеты управления контекстом

- [Enable-AzContextAutosave][enable] — возможность сохранять контекст для использования в разных сеансах PowerShell.
  Любые изменения влияют на глобальный контекст.
- [Disable-AzContextAutosave][disable] — отключение автосохранения контекста. Для работы с новым сеансом PowerShell нужно будет выполнить вход.
- [Select-AzContext][select] — выбор контекста по умолчанию. Все командлеты используют для аутентификации учетные данные из этого контекста.
- [Disconnect-AzAccount][remove-cred] — удаление всех учетных данных и контекстов, связанных с учетной записью.
- [Remove-AzContext][remove-context] — удаление именованного контекста.
- [Rename-AzContext][rename] — переименование существующего контекста.
- [Add-AzAccount][login] — возможность определения входа на уровне процесса или текущего пользователя.
  После аутентификации разрешено присваивать имя контексту по умолчанию.
- [Import-AzContext][import] — возможность входа на уровне процесса или текущего пользователя.
- [Set-AzContext][set-context] — возможность выбора существующих именованных контекстов и изменения области на уровне процесса или текущего пользователя.

<!-- Hyperlinks -->
[enable]: /powershell/module/az.accounts/Enable-AzureRmContextAutosave
[disable]: /powershell/module/az.accounts/Disable-AzContextAutosave
[select]: /powershell/module/az.accounts/Select-AzContext
[remove-cred]: /powershell/module/az.accounts/Disconnect-AzAccount
[remove-context]: /powershell/module/az.accounts/Remove-AzContext
[rename]: /powershell/module/az.accounts/Rename-AzContext

<!-- Updated cmdlets -->
[login]: /powershell/module/az.accounts/Connect-AzAccount
[import]:  /powershell/module/az.accounts/Import-AzContext
[set-context]: /powershell/module/az.accounts/Set-AzContext
